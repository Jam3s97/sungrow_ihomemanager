# Home Assistant Sungrow iHomeManager integration

modbus:
  - name: &sg_hub_name Sungrow_iHM
    type: tcp
    host: &sg_host 10.40.0.31 # TODO update with the IP of your iHM. No default. Check your router.
    port: &sg_port 503 # TODO update with the Modbus port of your iHM. Default is '502' but found 502 unresponsive.
    delay: 5
    timeout: 10

    sensors:

      # Input registers (address type: 3X)

      - name: "iHM total active power"
        unique_id: ihm_total_active_power
        address: 8154 # reg 8155
        slave: &sg_device_address 247 # TODO update with the slave address. Default 247
        input_type: input
        data_type: int32
        swap: word
        precision: 0
        scale: 10
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        scan_interval: &scan_interval_fast 10

      - name: "iHM meter power signed"
        unique_id: ihm_meter_power_signed
        address: 8156 # reg 8157
        slave: *sg_device_address
        input_type: input
        data_type: int32
        swap: word
        precision: 0
        scale: 10
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        scan_interval: *scan_interval_fast

      - name: "iHM load power"
        unique_id: ihm_load_power
        address: 8158 # reg 8159
        slave: *sg_device_address
        input_type: input
        data_type: int32
        swap: word
        precision: 0
        scale: 10
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        scan_interval: &scan_interval_realtime 5

      - name: "iHM grid import energy"
        unique_id: ihm_grid_import_energy
        address: 8175 # reg 8176
        slave: *sg_device_address
        input_type: input
        data_type: uint32
        swap: word
        precision: 1
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: total_increasing
        scale: 0.1
        scan_interval: &scan_interval_slowest 600

      - name: "iHM grid export energy"
        unique_id: ihm_grid_export_energy
        address: 8177 # reg 8178
        slave: *sg_device_address
        input_type: input
        data_type: uint32
        swap: word
        precision: 1
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: total_increasing
        scale: 0.1
        scan_interval: *scan_interval_slowest

      - name: "iHM charger status"
        unique_id: ihm_charger_status
        address: 8551 # reg 8552
        slave: *sg_device_address
        input_type: input
        data_type: uint16
        scan_interval: &scan_interval_medium 60

      # Hold registers (address type: 4X)

      - name: "iHM Energy management mode"
        unique_id: ihm_energy_management_mode
        address: 8023 # reg 8024
        slave: *sg_device_address
        input_type: holding
        data_type: uint16
        scan_interval: *scan_interval_medium

      - name: "iHM Charging/discharging command"
        unique_id: ihm_charging_discharging_command
        address: 8024 # reg 8025
        slave: *sg_device_address
        input_type: holding
        data_type: uint16
        scan_interval: *scan_interval_medium

      - name: "iHM Charging/discharging power"
        unique_id: ihm_charging_discharging_power
        address: 8025 # reg 8026
        slave: *sg_device_address
        input_type: holding
        data_type: uint32
        swap: word
        scale: 0.1
        precision: 1
        unit_of_measurement: "kW"
        device_class: power
        scan_interval: *scan_interval_medium

      - name: "iHM Feedin Power Limit Ratio"
        unique_id: ihm_feedin_power_limit_ratio
        address: 8030  # reg 8031
        slave: *sg_device_address
        input_type: holding
        data_type: int32
        swap: word
        scale: 0.1
        precision: 1
        min_value: 0
        max_value: 1000
        unit_of_measurement: "%"
        scan_interval: *scan_interval_medium

      - name: "iHM charger power status"
        unique_id: ihm_charger_power status
        address: 8046 # reg 8047
        slave: *sg_device_address
        input_type: holding
        data_type: uint16
        scan_interval: *scan_interval_medium

      - name: "iHM charger mode"
        unique_id: ihm_charger_mode
        address: 8047 # reg 8048
        slave: *sg_device_address
        input_type: holding
        data_type: uint16
        scan_interval: *scan_interval_medium

      - name: "iHM charger enabled"
        unique_id: ihm_charger_enabled
        address: 8048 # reg 8049
        slave: *sg_device_address
        input_type: holding
        data_type: uint16
        scan_interval: *scan_interval_medium

      - name: "iHM charger grid enabled"
        unique_id: ihm_charger_grid_enabled
        address: 8049 # reg 8050
        slave: *sg_device_address
        input_type: holding
        data_type: uint16
        scan_interval: *scan_interval_medium

      - name: "iHM charger power limitation"
        unique_id: ihm_charger_power_limitation
        address: 8050 # reg 8051
        slave: *sg_device_address
        input_type: holding
        data_type: uint16
        scan_interval: *scan_interval_medium


      # Returned value 32767 until I set value in correct range.
      - name: "iHM charger power limit"
        unique_id: ihm_charger_power_limit
        address: 8051 # reg 8052
        slave: *sg_device_address
        input_type: holding
        data_type: uint16
        scale: 0.1
        precision: 1
        min_value: 0
        max_value: 1000
        unit_of_measurement: "%"
        scan_interval: *scan_interval_medium

template:
  - sensor:
      - name: "iHM import power"
        unique_id: ihm_import_power
        device_class: power
        state_class: measurement
        unit_of_measurement: "W"
        availability: >-
          {{ states('sensor.ihm_meter_power_signed') not in ['unknown','unavailable',''] }}
        state: >-
          {% set v = states('sensor.ihm_meter_power_signed')|float(0) %}
          {{ (v if v > 0 else 0) | round(0) | int }}

      - name: "iHM export power"
        unique_id: ihm_export_power
        device_class: power
        state_class: measurement
        unit_of_measurement: "W"
        availability: >-
          {{ states('sensor.ihm_meter_power_signed') not in ['unknown','unavailable',''] }}
        state: >-
          {% set v = states('sensor.ihm_meter_power_signed')|float(0) %}
          {{ ((-v) if v < 0 else 0) | round(0) | int }}

        # status 4 was seen shortly after connecting charger. may need to check iSolarCloud logs to determine what it is.
        # add icon for status 4 once determined
      - name: "EV Charger Status"
        unique_id: ihm_charger_status_friendly
        state: >
          {% set status = states('sensor.ihm_charger_status') | int(0) %}
          {% if status == 1 %}
            Idle (unplugged)
          {% elif status == 2 %}
            Standby (plugged)
          {% elif status == 3 %}
            Charging
          {% elif status == 4 %}
            Unknown
          {% elif status == 5 %}
            Charging suspended
          {% elif status == 6 %}
            Charging completed
          {% else %}
            Unknown
          {% endif %}
        icon: >
          {% set status = states('sensor.ihm_charger_status') | int(0) %}
          {% if status == 1 %}
            mdi:ev-plug-type2
          {% elif status == 2 %}
            mdi:battery-charging-outline
          {% elif status == 3 %}
            mdi:battery-charging
          {% elif status == 5 %}
            mdi:battery-charging-outline
          {% elif status == 6 %}
            mdi:battery-check
          {% else %}
            mdi:help-circle
          {% endif %}

      - name: "iHM Energy Management Mode Friendly"
        unique_id: ihm_energy_management_mode_friendly
        state: >
          {% set mode = states('sensor.ihm_energy_management_mode') | int(0) %}
          {% if mode == 1 %}
            Self-consumption
          {% elif mode == 2 %}
            Time Plan
          {% elif mode == 0 %}
            AI Mode
          {% elif mode == 4 %}
            VPP
          {% elif mode == 5 %}
            Forced Mode
          {% else %}
            Unknown ({{ mode }})
          {% endif %}
        icon: >
          {% set mode = states('sensor.ihm_energy_management_mode') | int(0) %}
          {% if mode == 1 %}
            mdi:home-lightning-bolt
          {% elif mode == 2 %}
            mdi:clock
          {% elif mode == 0 %}
            mdi:magic-staff
          {% elif mode == 4 %}
            mdi:transmission-tower
          {% elif mode == 5 %}
            mdi:lock
          {% else %}
            mdi:help-circle
          {% endif %}

      - name: "iHM Battery Command Friendly"
        unique_id: ihm_battery_command_friendly
        state: >
          {% set cmd = states('sensor.ihm_charging_discharging_command') | int(0) %}
          {% if cmd == 170 %}
            Charging
          {% elif cmd == 187 %}
            Discharging
          {% elif cmd == 204 %}
            Stopped
          {% else %}
            Unknown ({{ cmd }})
          {% endif %}
        icon: >
          {% set cmd = states('sensor.ihm_charging_discharging_command') | int(0) %}
          {% if cmd == 170 %}
            mdi:battery-charging
          {% elif cmd == 187 %}
            mdi:battery-minus
          {% elif cmd == 204 %}
            mdi:battery-off
          {% else %}
            mdi:help-circle
          {% endif %}

      - name: "EV Charger Mode"
        unique_id: ihm_charger_mode_friendly
        state: >
          {% set mode = states('sensor.ihm_charger_mode') | int(0) %}
          {% if mode == 164 %}
            Fast charging
          {% elif mode == 165 %}
            Eco & fast charging
          {% elif mode == 166 %}
            Eco & economic charging
          {% else %}
            Unknown ({{ mode }})
          {% endif %}
        icon: >
          {% set mode = states('sensor.ihm_charger_mode') | int(0) %}
          {% if mode == 164 %}
            mdi:lightning-bolt
          {% elif mode == 165 %}
            mdi:lightning-bolt
          {% elif mode == 166 %}
            mdi:leaf
          {% else %}
            mdi:help-circle
          {% endif %}

  - binary_sensor:

      # 170 = enabled, 85 = disabled
      - name: "EV Charger Grid Enabled"
        unique_id: ihm_charger_grid_enabled_friendly
        state: >
          {{ states('sensor.ihm_charger_grid_enabled') | int(0) == 170 }}
        device_class: power
        icon: >
          {% if states('sensor.ihm_charger_grid_enabled') | int(0) == 170 %}
            mdi:transmission-tower-export
          {% else %}
            mdi:transmission-tower-off
          {% endif %}

  - binary_sensor:
      - name: "iHM Charger Enabled"
        unique_id: ihm_charger_enabled_binary
        state: >
          {{ states('sensor.ihm_charger_enabled') | int(0) == 170 }}
        icon: >
          {% if states('sensor.ihm_charger_enabled') | int(0) == 170 %}
            mdi:ev-station
          {% else %}
            mdi:power-plug-off-outline
          {% endif %}

      - name: "EV Charger Power Limit Enabled"
        unique_id: ihm_charger_power_limitation_friendly
        state: >
          {{ states('sensor.ihm_charger_power_limitation') | int(0) == 170 }}
        device_class: power
        icon: >
          {% if states('sensor.ihm_charger_power_limitation') | int(0) == 170 %}
            mdi:speedometer
          {% else %}
            mdi:speedometer-slow
          {% endif %}
